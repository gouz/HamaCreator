const e=document.querySelector("#mockup"),t=e.getContext("2d"),l=document.createElement("img"),n=document.querySelector("#temp"),o=n.getContext("2d"),r=document.querySelector("#horizontal"),i=document.querySelector("#vertical");let a=1,c=1,s=[],d={},h={};const p=document.querySelector("#palette"),u=document.querySelector("#spinner"),g=document.querySelector("#instructions"),f=document.querySelector("#loadimg");let y="";fetch("./list.json").then((e=>e.json())).then((e=>{p.innerHTML="";for(let t=0;t<e.palette.length;t++)d[e.palette[t].color]=e.palette[t],d[e.palette[t].color].code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-*/$!?".charAt(t),s.push(e.palette[t].color),p.innerHTML+=`\n        <label title="${e.palette[t].label}">\n          <input class="color-picked" type="checkbox" value="${e.palette[t].color}" checked />\n          <span class="border">\n            <span class="color" style="background-color: ${e.palette[t].color};"></span>\n            <span class="number">${e.palette[t].num}</span>\n            </span>\n          <span class="sr-only">${e.palette[t].label}</span>\n        </label>\n      `;document.querySelectorAll(".color-picked").forEach((e=>{e.addEventListener("click",(()=>{e.checked?s.push(e.value):s.splice(s.indexOf(e.value),1),k(),L()}),!1)}))}));const m=e=>{let t=768,l=s[0];for(let n=0;n<s.length;n++){let o=0;for(let t=0;t<3;t++)o+=Math.abs(e[t]-parseInt(s[n].substring(2*t+1,2*t+3),16));o<t&&(t=o,l=s[n])}return l},v=()=>{for(let e=0;e<29*a;e++)for(let l=0;l<29*c;l++){let n=a;c>a&&(n=c),t.beginPath(),t.fillStyle="#999999",t.fillRect((10+20*e)/n,(10+20*l)/n,1,1),t.stroke()}},b=()=>{a>c?(e.width=580,e.height=580*c/a):(e.width=580*a/c,e.height=580),v(),g.innerHTML="",""!=l.src&&(u.style.display="block",w())},k=()=>{if(s.length){y="",h={};for(let e=0;e<n.height;e++){for(let l=0;l<n.width;l++){const n=o.getImageData(l,e,1,1).data;if(0!=n[3]){t.beginPath();let o=a;c>a&&(o=c),t.arc((10+20*l)/o,(10+20*e)/o,8/o,0,2*Math.PI),t.lineWidth=5/o;const r=m(n);t.strokeStyle=r,void 0===h[r]&&(h[r]=0),h[r]++,y+=`<i style="color: ${d[r].color}">${d[r].code}</i>`,t.stroke()}else y+="&nbsp;"}y+="<br />"}}else alert("Pas de coloris sélectionné")},L=()=>{if(""!=y){let e=[],t=0;for(const l in h)e.push(`(${d[l].num}) ${d[l].label} [<span class="key" style="color: ${d[l].color}">${d[l].code}</span>] : ${h[l]}`),t+=h[l];e.sort(),g.innerHTML=`\n      <p>Nombre de perles à utiliser (${t})</p>\n      <ul>\n        <li>${e.join("</li><li>")}</li>\n      </ul>\n      <p>Instructions</p>\n      <p class="key">${y}</p>\n    `}else g.innerHTML=""},w=()=>{t.clearRect(0,0,e.width,e.height),o.clearRect(0,0,n.width,n.height),v(),(()=>{n.width=29*a,n.height=29*c;let e=l.width,t=l.height;t*=n.width/e,e=n.width,t>n.height&&(e*=n.height/t,t=n.height),o.drawImage(l,0,0,l.width,l.height,(n.width-e)/2,(n.height-t)/2,e,t)})(),k(),L(),u.style.display="none"},$=e=>{if(e.length>0){const t=e[0];if("undefined"!=typeof FileReader&&-1!=t.type.indexOf("image")){g.innerHTML="",u.style.display="block";const e=new FileReader;e.onload=e=>{l.src=e.target.result},e.readAsDataURL(t)}}};l.addEventListener("load",(()=>{w()}),!1),e.addEventListener("dragover",(e=>{e.preventDefault()}),!1),e.addEventListener("drop",(e=>{$(e.dataTransfer.files),e.preventDefault()}),!1),e.addEventListener("click",(e=>{f.click()}),!1),r.addEventListener("input",(()=>{a=r.value,b()}),!1),i.addEventListener("input",(()=>{c=i.value,b()}),!1),f.addEventListener("change",(e=>{$(e.target.files)}),!1),window.addEventListener("load",(()=>{b()}));
const e=document.querySelector("#mockup"),t=e.getContext("2d"),n=document.createElement("img"),l=document.querySelector("#temp"),o=l.getContext("2d"),r=document.querySelector("#horizontal"),c=document.querySelector("#vertical");let i=1,a=1,s=[],d={},u={};const h=document.querySelector("#palette"),p=document.querySelector("#spinner"),g=document.querySelector("#instructions");let y,m=!0;fetch("./list.json").then((e=>e.json())).then((e=>{h.innerHTML="";for(let t=0;t<e.palette.length;t++)d[e.palette[t].color]=e.palette[t],d[e.palette[t].color].code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-*/$!?".charAt(t),s.push(e.palette[t].color),h.innerHTML+=`\n        <label title="${e.palette[t].label}">\n          <input class="color-picked" type="checkbox" value="${e.palette[t].color}" checked />\n          <span class="border">\n            <span class="color" style="background-color: ${e.palette[t].color};"></span>\n            <span class="number">${e.palette[t].num}</span>\n            </span>\n          <span class="sr-only">${e.palette[t].label}</span>\n        </label>\n      `;h.innerHTML+='<button id="toggle">Aucun</button>',document.querySelector("#toggle").addEventListener("click",(()=>{document.querySelectorAll(".color-picked").forEach((e=>{e.checked=m,e.click()})),m?document.querySelector("#toggle").innerHTML="Tous":(document.querySelector("#toggle").innerHTML="Aucun",k(),v()),m=!m}),!1),document.querySelectorAll(".color-picked").forEach((e=>{e.addEventListener("click",(()=>{e.checked?s.push(e.value):s.splice(s.indexOf(e.value),1),k(),v()}),!1)}))}));const f=e=>{let t=768,n=s[0];for(let l=0;l<s.length;l++){let o=0;for(let t=0;t<3;t++)o+=Math.abs(e[t]-parseInt(s[l].substring(2*t+1,2*t+3),16));o<t&&(t=o,n=s[l])}return n},b=()=>{i>a?(e.width=580,e.height=580*a/i):(e.width=580*i/a,e.height=580),g.innerHTML=""},k=()=>{if(s.length){y="",u={};for(let e=0;e<l.height;e++){for(let n=0;n<l.width;n++){const l=o.getImageData(n,e,1,1).data;if(0!=l[3]){t.beginPath();let o=i;a>i&&(o=a),t.arc((10+20*n)/o,(10+20*e)/o,8/o,0,2*Math.PI),t.lineWidth=5/o;const r=f(l);t.strokeStyle=r,void 0===u[r]&&(u[r]=0),u[r]++,y+=`<i style="color: ${d[r].color}">${d[r].code}</i>`,t.stroke()}else y+="&nbsp;"}y+="<br />"}}else alert("Pas de coloris sélectionné")},v=()=>{if(""!=y){let e=[],t=0;for(const n in u)e.push(`(${d[n].num}) ${d[n].label} [<span class="key" style="color: ${d[n].color}">${d[n].code}</span>] : ${u[n]}`),t+=u[n];e.sort(),g.innerHTML=`\n      <p>Nombre de perles à utiliser (${t})</p>\n      <ul>\n        <li>${e.join("</li><li>")}</li>\n      </ul>\n      <p>Instructions</p>\n      <p class="key">${y}</p>\n    `}else g.innerHTML=""};n.addEventListener("load",(()=>{t.clearRect(0,0,e.width,e.height),o.clearRect(0,0,l.width,l.height),(()=>{l.width=29*i,l.height=29*a;let e=n.width,t=n.height;t*=l.width/e,e=l.width,t>l.height&&(e*=l.height/t,t=l.height),o.drawImage(n,0,0,n.width,n.height,(l.width-e)/2,(l.height-t)/2,e,t)})(),k(),v(),p.style.display="none"}),!1),e.addEventListener("dragover",(e=>{e.preventDefault()}),!1),e.addEventListener("drop",(e=>{const t=e.dataTransfer.files;if(t.length>0){const e=t[0];if("undefined"!=typeof FileReader&&-1!=e.type.indexOf("image")){g.innerHTML="",p.style.display="block";const t=new FileReader;t.onload=e=>{n.src=e.target.result},t.readAsDataURL(e)}}e.preventDefault()}),!1),r.addEventListener("input",(()=>{i=r.value,b()}),!1),c.addEventListener("input",(()=>{a=c.value,b()}),!1);
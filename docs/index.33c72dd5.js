const e=document.querySelector("#mockup"),t=e.getContext("2d"),l=document.createElement("img"),n=document.querySelector("#temp"),o=n.getContext("2d"),r=document.querySelector("#horizontal"),a=document.querySelector("#vertical");let i=1,s=1,c=[],d={},h={};const p=document.querySelector("#palette"),u=document.querySelector("#spinner"),g=document.querySelector("#instructions");let f="";fetch("./list.json").then((e=>e.json())).then((e=>{p.innerHTML="";for(let t=0;t<e.palette.length;t++)d[e.palette[t].color]=e.palette[t],d[e.palette[t].color].code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-*/$!?".charAt(t),c.push(e.palette[t].color),p.innerHTML+=`\n        <label title="${e.palette[t].label}">\n          <input class="color-picked" type="checkbox" value="${e.palette[t].color}" checked />\n          <span class="border">\n            <span class="color" style="background-color: ${e.palette[t].color};"></span>\n            <span class="number">${e.palette[t].num}</span>\n            </span>\n          <span class="sr-only">${e.palette[t].label}</span>\n        </label>\n      `;document.querySelectorAll(".color-picked").forEach((e=>{e.addEventListener("click",(()=>{e.checked?c.push(e.value):c.splice(c.indexOf(e.value),1),v(),k()}),!1)}))}));const y=e=>{let t=768,l=c[0];for(let n=0;n<c.length;n++){let o=0;for(let t=0;t<3;t++)o+=Math.abs(e[t]-parseInt(c[n].substring(2*t+1,2*t+3),16));o<t&&(t=o,l=c[n])}return l},m=()=>{for(let e=0;e<29*i;e++)for(let l=0;l<29*s;l++){let n=i;s>i&&(n=s),t.beginPath(),t.fillStyle="#999999",t.fillRect((10+20*e)/n,(10+20*l)/n,1,1),t.stroke()}},b=()=>{i>s?(e.width=580,e.height=580*s/i):(e.width=580*i/s,e.height=580),m(),g.innerHTML="",""!=l.src&&(u.style.display="block",w())},v=()=>{if(c.length){f="",h={};for(let e=0;e<n.height;e++){for(let l=0;l<n.width;l++){const n=o.getImageData(l,e,1,1).data;if(0!=n[3]){t.beginPath();let o=i;s>i&&(o=s),t.arc((10+20*l)/o,(10+20*e)/o,8/o,0,2*Math.PI),t.lineWidth=5/o;const r=y(n);t.strokeStyle=r,void 0===h[r]&&(h[r]=0),h[r]++,f+=`<i style="color: ${d[r].color}">${d[r].code}</i>`,t.stroke()}else f+="&nbsp;"}f+="<br />"}}else alert("Pas de coloris sélectionné")},k=()=>{if(""!=f){let e=[],t=0;for(const l in h)e.push(`(${d[l].num}) ${d[l].label} [<span class="key" style="color: ${d[l].color}">${d[l].code}</span>] : ${h[l]}`),t+=h[l];e.sort(),g.innerHTML=`\n      <p>Nombre de perles à utiliser (${t})</p>\n      <ul>\n        <li>${e.join("</li><li>")}</li>\n      </ul>\n      <p>Instructions</p>\n      <p class="key">${f}</p>\n    `}else g.innerHTML=""},w=()=>{t.clearRect(0,0,e.width,e.height),o.clearRect(0,0,n.width,n.height),m(),(()=>{n.width=29*i,n.height=29*s;let e=l.width,t=l.height;t*=n.width/e,e=n.width,t>n.height&&(e*=n.height/t,t=n.height),o.drawImage(l,0,0,l.width,l.height,(n.width-e)/2,(n.height-t)/2,e,t)})(),v(),k(),u.style.display="none"};l.addEventListener("load",(()=>{w()}),!1),e.addEventListener("dragover",(e=>{e.preventDefault()}),!1),e.addEventListener("drop",(e=>{const t=e.dataTransfer.files;if(t.length>0){const e=t[0];if("undefined"!=typeof FileReader&&-1!=e.type.indexOf("image")){g.innerHTML="",u.style.display="block";const t=new FileReader;t.onload=e=>{l.src=e.target.result},t.readAsDataURL(e)}}e.preventDefault()}),!1),r.addEventListener("input",(()=>{i=r.value,b()}),!1),a.addEventListener("input",(()=>{s=a.value,b()}),!1),window.addEventListener("load",(()=>{b()}));